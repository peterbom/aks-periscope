#!/usr/bin/env bash

image_tag="$1"
if [ -z "$image_tag" ]; then
    echo "No image tag supplied"
    exit 1
fi

overlay="$2"
if [ -z "$overlay" ]; then
    echo "No overlay supplied"
    exit 1
fi

script_dir=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
repo_dir=$(realpath "$script_dir/../../..")

kust_dir="$script_dir/$overlay"
publish_dir="$repo_dir/publish"
output_path="$publish_dir/$overlay.yaml"

mkdir -p "$publish_dir"

image_tag_placeholder="<<imageTag:string>>"
sas_placeholder="<<sas:base64string>>"
account_name_placeholder="<<accountName:base64string>>"
container_name_placeholder="<<containerName:base64string>>"

# Placeholders that end up in secrets will be base64-encoded in the output generated by kustomize.
# Work out what the encoded placeholders will be so that we can replace them with unencoded ones.
sas_placeholder_b64=$(echo -n "${sas_placeholder}" | base64)
acct_name_placeholder_b64=$(echo -n "${account_name_placeholder}" | base64)
cont_name_placeholder_b64=$(echo -n "${container_name_placeholder}" | base64)

kubectl kustomize "$kust_dir" \
  | sed -e "s/$image_tag_placeholder/$image_tag/g" \
  | sed -e "s/$sas_placeholder_b64/$sas_placeholder/g" \
  | sed -e "s/$acct_name_placeholder_b64/$account_name_placeholder/g" \
  | sed -e "s/$cont_name_placeholder_b64/$container_name_placeholder/g" \
  > "$output_path"